name: Beagle Automated Tests

on: workflow_dispatch

env:
    CACHE_PATH: ${{ runner.os }}-build
    CACHE_GRADLE_PATH: ${{ CACHE_PATH }}-gradle-cache

jobs:
    run-automated-tests:
        name: Run automated tests
        runs-on: macos-latest
        steps:
            -   uses: actions/checkout@v2

            # Fastlane
            -   name: Cache fastlane dependencies
                uses: actions/cache@v2
                with:
                    path: ~/.gem
                    key: ${{ CACHE_PATH }}-fastlane-cache-${{ hashFiles('Gemfile.lock') }}
                    restore-keys: ${{ CACHE_PATH }}-fastlane-cache-

            -   name: Install Fastlane
                run: bundle config set path '~/.gem' && bundle install

            # Backend
            -   name: Cache gradle dependencies
                uses: actions/cache@v2
                with:
                    path: ~/.gradle
                    key: ${{ CACHE_GRADLE_PATH }}-${{ hashFiles('backend/buildSrc/**', 'android/buildSrc/**') }}
                    restore-keys: ${{ CACHE_GRADLE_PATH }}
                    
            -   name: Start backend in background
                run: bash fastlane/automatedTests/start_test_backend.sh

            # Android
            -   name: Cache android multiple things
                uses: actions/cache@v2
                with:
                    path: |
                        /Users/runner/Library/Android/sdk/platforms
                        /Users/runner/Library/Android/sdk/system-images
                        ~/.android
                    key: ${{ CACHE_PATH }}-android-cache-${{ hashFiles('fastlane/automatedTests/run_android_automation.sh') }}
            
            -   name: Test Android
                run: bash fastlane/automatedTests/run_android_automation.sh
                env:
                    ANDROID_SDK_ROOT: /Users/runner/Library/Android/sdk

            # iOS
            -   name: Test iOS
                run: bundle exec fastlane automated_tests run_ios_automation

            # END
            -   name: Cleanup
                run: bundle exec fastlane automated_tests cleanup
