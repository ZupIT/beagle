name: Beagle Appium Android Tests

# on: workflow_dispatch
# testing for this PULL REQUEST only. Will be set back to 'workflow_dispatch' afterwards 
on:
    push:
        branches:
            - master
        paths:
            - '.github/**'
    pull_request:
        paths:
            - '.github/**'

jobs:
     
    appium_tests:
        
        name: Run Appium Android tests
        runs-on: macos-latest
        steps:
            -   uses: actions/checkout@v2

            -   name: Cache fastlane dependences
                uses: actions/cache@v2
                env:
                    fastlane-cache-key: fastlane-cache-test
                    fastlane-path: ~/.gem
                with:
                     path: ${{ env.fastlane-path }}
                     key: ${{ runner.os }}-build-${{ env.fastlane-cache-key }}-${{ hashFiles('Gemfile.lock') }}
            
            -   name: Install Fastlane
                run: bundle config set path '~/.gem' && bundle install

            -   name: Cache Beagle backend gradle dependencies
                uses: actions/cache@v2
                env:
                     gradle-cache-key: backend-tests-gradle-cache
                     gradle-path: ~/.gradle
                with:
                     path: ${{ env.gradle-path }}
                     key: ${{ runner.os }}-build-${{ env.gradle-cache-key }}-${{ hashFiles('backend/buildSrc/**') }}
                     restore-keys: ${{ runner.os }}-build-${{ env.gradle-cache-key }}
            
            -   name: Start Beagle backend in background
                run: bash fastlane/automatedTests/start_test_backend.sh

            -   name: Wait for server to start
                run: sleep 30

            -   name: Cache Appium app-android gradle dependencies
                uses: actions/cache@v2
                env:
                    gradle-cache-key: app-android-tests-gradle-cache
                    gradle-path: ~/.gradle
                with:
                     path: ${{ env.gradle-path }}
                     key: ${{ runner.os }}-build-${{ env.gradle-cache-key }}-${{ hashFiles('/tests/appium/app-android/buildSrc/**') }}
                     restore-keys: ${{ runner.os }}-build-${{ env.gradle-cache-key }}

            -   name: build app-android project
                run: | 
                    java -version
                    javac -version
                    bash ./tests/appium/app-android/gradlew -p tests/appium/app-android assembleDebug
                        
            -   name: Config and run Appium server
                run: bash fastlane/automatedTests/appium/android/config_and_run_appium_server.sh

            -   name: Run Appium tests
                uses: reactivecircus/android-emulator-runner@v2
                with:
                    api-level: 30
                    target: google_apis
                    arch: x86_64
                    profile: Nexus 6
                    avd_name: Nexus6
                    disable-animations: true
                    script: ./tests/appium/project/gradlew -p tests/appium/project cucumber -Dplatform=android     

            -   name: Expose failed test screenshot files
                if: failure()
                uses: actions/upload-artifact@v2
                with:
                     name: failed_tests_screenshots
                     path: tests/appium/project/build/screenshots/

#            -   name: Cleanup
#                run: bundle exec fastlane automated_tests cleanup
